
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="{if: $page.desc}{$page.desc}{else}{$settings.description}{/if}">
    <title>{$title} - {$settings.nama_instansi}</title>
    <link rel="icon" href="{{?=url()?}/favicon.png" type="image/x-icon">
    <link rel="stylesheet" href="{?=url()?}/assets/css/bootstrap.min.css">
    <link href="{?=url()?}/assets/css/font-awesome.css" rel="stylesheet">
    <script src="{?=url()?}/assets/jscripts/jquery.min.js"></script>
    <script src="{?=url()?}/assets/jscripts/bootstrap.min.js"></script>
    <style media="screen">
      body {
        font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
        color: #fff;
      	background: #0264d6;
      	height:calc(100vh);
      	width:100%;
      }
      .antrian_judul {
        font-size:56px;
        padding-bottom:20px;
      }
      .loket {
        padding: 0;
      }
      .loket a {
        text-decoration: none;
      }
      .kiri {
        float: left;
        width:80%;
        padding: 10px;
      }
      .kanan {
        float: right;
        width:20%;
        padding: 10px;
      }
      .panel-body .no_antrian {
        font-size:100px;
        font-weight:lighter;
        padding:0;
        margin-top:-45px;
        margin-bottom:-45px;
      }
      .panel-footer .no_loket {
        font-size:40px;
        color: #000;
        padding-top:0;
        padding-bottom:0;
      }
      .panel-body .date {
        font-size:21px;
        color: #FF0000;
        font-weight:lighter;
        padding-top:5px;
        padding-bottom:5px;
        margin-top:-20px;
        margin-bottom:-25px;
      }
      .panel-footer .clock {
        font-size:26px;
        color: #000;
        padding-top:0;
        padding-bottom:0;
      }
      .panel-title.marquee {
         font-size:36px;
         padding-top: 10px;
         padding-bottom: 0px;
         margin-top: 10px;
         margin-bottom: 10px;
         color: #FF0000;
         background-color: #fff;
      }
      footer {
          position: fixed;
          right: 0px;
          bottom: 0px;
          height: 40px;
          width: calc(100% - 0px);
          font-size: 14px;
          color: #fff;
      }
      footer a, footer a:hover {
        color: #fff;
      }
    </style>
</head>
<body>
  <div class="container-fluid">
    {if: !$show}
    <h1 class="text-center text-white antrian_judul"><img class="logo" src="{?=url()?}/{$logo}" alt="" width="80px"> Antrian Loket {$settings.nama_instansi}</h1>
    <div class="row loket">
      <div class="kiri">
        <div class="card bg-dark text-white">
          <div class="embed-responsive embed-responsive-16by9">
            <iframe class="embed-responsive-item" src="https://www.youtube.com/embed/{$vidio}?rel=0&modestbranding=1&autohide=1&mute=0&showinfo=0&controls=1&loop=1&autoplay=1&playlist={$vidio}" allowfullscreen></iframe>
          </div>
        </div>
      </div>
      <div class="kanan">
          <a href="{?=url()?}/anjungan/loket?show=panggil_loket" target="_blank">
            <div class="panel border-success">
              <div class="panel-body text-success">
                <div class="no_antrian">A<span class="antrian_Loket"><span></div>
              </div>
              <div class="panel-footer bg-transparent border-success">
                <div class="no_loket">Loket <span class="get_loket"><span></div>
              </div>
            </div>
          </a>
          <a href="{?=url()?}/anjungan/loket?show=panggil_cs" target="_blank">
            <div class="panel border-success">
              <div class="panel-body text-success">
                <div class="no_antrian">B<span class="antrian_CS"><span></div>
              </div>
              <div class="panel-footer bg-transparent border-success">
                <div class="no_loket">Loket <span class="get_cs"><span></div>
                </div>
            </div>
          </a>
          <div class="panel border-success">
            <div class="panel-body text-success">
              <div class="date">
                <script type='text/javascript'>
                  <!--
                  var months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                  var myDays = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jum&#39;at', 'Sabtu'];
                  var date = new Date();
                  var day = date.getDate();
                  var month = date.getMonth();
                  var thisDay = date.getDay(),
                      thisDay = myDays[thisDay];
                  var yy = date.getYear();
                  var year = (yy < 1000) ? yy + 1900 : yy;
                  document.write(thisDay + ', ' + day + ' ' + months[month] + ' ' + year);
                  //-->
                </script>
              </div>
            </div>
            <div class="panel-footer border-success" style="background-color:#ffcc00;">
              <div class="clock"><span id="clock"><span></div>
            </div>
          </div>
      </div>
  </div>
  <div class="row">
    <div class="panel-title marquee">
      <marquee>{$running_text}</marquee>
    </div>
  </div>
  {/if}
  {if: $show == 'panggil_loket' || $show == 'panggil_cs'}
  <div align="center" style="font-size: 64px;color:white; text-shadow: 2px 2px 4px #000000;margin:30px;"><img class="logo" src="{?=url()?}/{$logo}" alt="" width="80px"> Pemanggil Antrian Loket</div>
  <div class="container text-center">
    <div class="row">
      <div class="card-deck">
          {loop: $loket}
          <div class="col-xs-12 col-sm-6 col-md-4 col-lg-4 mb-5">
            <div class="panel" style="color:#000;">
              <div class="panel-heading" style="font-size:32px;">Loket {$value}</div>
              <div class="panel-body">
                <h5 class="panel-title" style="font-size:72px;">{?=strtoupper($namaloket)?}{$antrian}</h5>
              </div>
              <div class="panel-footer">
                <div class="btn-group btn-group-justified">
                  <a href="#" class="btn btn-primary" style="font-size:32px;">{$noantrian}</a>
                  <a href="#" class="btn btn-primary" style="font-size:32px;" onclick="panggil({$antrian})"><i class="fa fa-bullhorn"></i></a>
                  <a href="{?=url()?}/anjungan/loket?show={$panggil_loket}&loket={$value}" class="btn btn-primary" style="font-size:32px;"><i class="fa fa-forward"></i></a>
                </div>
                <br>
                <div class="col" id="form_simpan_no_rkm_medis_{$value}">
                    <input type="hidden" name="noantrian" value="{$antrian}">
                    <div class="input-group input-group-lg">
                        <input type="text" class="form-control form-control-lg" name="no_rkm_medis_{$value}" placeholder="Input Nomor RM">
                        <span class="input-group-btn"><!-- Append button addon using class input-group-lg -->
                            <button class="btn btn-danger simpan_no_rkm_medis_{$value}">Simpan</button>
                        </span>
                    </div>
                </div>
              </div>
            </div>
          </div>
          {/loop}
      </div>
    </div>
  </div>
  <div class="text-center" style="width: 300px;margin: 20px auto;">
    <form action="">
      <input type="hidden" name="show" value="{$panggil_loket}">
      <input type="hidden" name="reset" value="{?=isset($_GET['loket'])?$_GET['loket']:'1'?}">
      <div class="row">
        <div class="col">
            <div class="input-group input-group-lg">
                <input type="text" class="form-control form-control-lg" name="antrian" placeholder="Input Nomor Antrian">
                <span class="input-group-btn"><!-- Append button addon using class input-group-lg -->
                    <button class="btn btn-danger" type="submit">Panggil</button>
                </span>
            </div>
        </div>
      </div>
    </form>
  </div>

  <div class="container">
  	<ul class="text-white">
  		<li>Klik tombol <i class="fa fa-forward"></i> 1x untuk memanggil antrian selanjutnya</li>
  		<li>Klik tombol <i class="fa fa-bullhorn"></i> 1x untuk memanggil ulang antrian</li>
  		<li>Untuk menyesuaikan urutan, masukkan nomor urut pada kolom lompat dan klik tombol panggil 1x</li>
  		<li>Angka di Sebelah Kiri Tombol Pemanggil Menunjukan Jumlah Nomor Antrian Yang Telah diambil Pasien</li>
  	</ul>
  </div>
  {/if}
  <footer class="visible-lg visible-md bg-primary" style="padding:10px;z-index:1000;">
    <div class="canvas">
      <p class="pull-right">
        Made with <i class="fa fa-heart text-danger"></i> by <a href="https://basoro.id/" target="_blank"><b>drg. F. Basoro</b>.</a>
        {$powered}.
      </p>
      {if: $show}
      <p><i class="fa fa-fw fa-calendar"></i> <span>{$tanggal}</span> <i class="fa fa-fw fa-clock-o"></i><span id="clock"></span> <i class="fa fa-fw fa-user"></i> <span>{?= sprintf('Login sebagai <strong>%s</strong>', $username) ?}</span></p>
      {/if}
    </div>
  </footer>

  <script type="text/javascript">
  function showTime() {
      var a_p = "";
      var today = new Date();
      var curr_hour = today.getHours();
      var curr_minute = today.getMinutes();
      var curr_second = today.getSeconds();
      if (curr_hour < 12) {
          a_p = "AM";
      } else {
          a_p = "PM";
      }
      if (curr_hour == 0) {
          curr_hour = 12;
      }
      if (curr_hour > 12) {
          curr_hour = curr_hour - 12;
      }
      curr_hour = checkTime(curr_hour);
      curr_minute = checkTime(curr_minute);
      curr_second = checkTime(curr_second);
      document.getElementById('clock').innerHTML = curr_hour + ":" + curr_minute + ":" + curr_second + " " + a_p;
      }

  function checkTime(i) {
      if (i < 10) {
          i = "0" + i;
      }
      return i;
  }
  setInterval(showTime, 500);
  </script>
  {if: !$show}
  <script>
  $(document).ready(function(){
    setTimeout(function(){
      getAntrian();
    }, 4000);
  });

  function getAntrian() {
    $.ajax({
        url: '{?=url()?}/anjungan/panggilantrian',
        dataType: 'json',
        success: function(data) {
            if(data.status == false) {
                setTimeout(function(){
                    getAntrian();
                }, 3000);
            } else {
                updateLayar(data.type, data.noantrian, data.loket);
                panggil(data.panggil);
                setSelesai(data.id);
            }
        },
        error: function(xhr) {
            console.log('An error occured.');
            console.log(xhr.status);
            setTimeout(function(){
                getAntrian();
            }, 3000);
        }
    });
  }

  function updateLayar(type, nomor, loket) {
    $('.antrian_' + type).html(nomor);
    $('.get_' + type).html(loket);
  }

  function panggil(data) {
    var ass = new Array();

    $.each(data, function(key, value){
        var filename = "{?=url()?}/plugins/anjungan/suara/" + value + ".wav";
        var auau = new Audio(filename);
        ass.push(auau);
    });

    console.log(ass);
    play_sound_queue(ass);
  }

  function play(audio, callback) {
    var akhir = true;

    audio.playbackRate = 1.0;

    const playPromise = audio.play();
    if (playPromise !== null){
        playPromise.catch(() => { media.play(); })
    }

    if (callback) {
        //When the audio object completes it's playback, call the callback
        //provided
        audio.addEventListener('ended', callback);
        var akhir = false;
    }

    if(akhir == true) {
        audio.addEventListener('ended', function(){
            getAntrian();
        });
    }
  }

  //Changed the name to better reflect the functionality
  function play_sound_queue(sounds) {
    var index = 0;
    function recursive_play() {
        //If the index is the last of the table, play the sound
        //without running a callback after
        if (index + 1 === sounds.length) {
            play(sounds[index], null);
        } else {
            //Else, play the sound, and when the playing is complete
            //increment index by one and play the sound in the
            //indexth position of the array
            play(sounds[index], function() {
                index++;
                recursive_play();
            });
        }
    }
    //Call the recursive_play for the first time
    recursive_play();
  }

  function setSelesai(id) {
    $.ajax({
        url: '{?=url()?}/anjungan/panggilselesai',
        dataType: 'json',
        data: { id: id },
        error: function(xhr) {
            console.log(xhr.status);
        }
    });

  }
  </script>
  {/if}
  {if: $show == 'panggil_loket' || $show == 'panggil_cs'}
  <script>
  function panggil(noantrian) {
    var loket = '';
    {if: isset($_GET['loket']) && $_GET['loket'] !=''}
  	var loket = "{?=$_GET['loket']?}";
    {/if}
    alert('Panggil ' + loket + ' - ' + noantrian);
  	$.ajax({
  		url: '{?=url()?}/anjungan/setpanggil',
  		dataType: 'json',
  		data: {
  			noantrian: noantrian,
  			type: '{?=str_replace("panggil_","",$_GET['show'])?}',
  			loket: loket,
  		},
  		success: function(data) {
  			console.log(data);
  		},
  		error: function(xhr) {
  			console.log(xhr.status);
  		}
  	});
  }
  {loop: $loket}
  $("#form_simpan_no_rkm_medis_{$value}").on("click", ".simpan_no_rkm_medis_{$value}", function(event){
    var noantrian = $('input:hidden[name=noantrian]').val();
    var no_rkm_medis = $('input:text[name=no_rkm_medis_{$value}]').val();
    $.ajax({
        url: '{?=url()?}/anjungan/simpannorm',
        dataType: 'json',
        data: { noantrian: noantrian, no_rkm_medis: no_rkm_medis },
        success: function(xhr) {
            console.log(xhr.status);
            if(xhr.status == true) {
              alert('Simpan nomor RM berhasil!!')
            }
        },
        error: function(xhr) {
            console.log(xhr.status);
            if(xhr.status == false) {
              alert('Simpan nomor RM gagal!!')
            }
        }
    });
  });
  {/loop}
  </script>
  {/if}
</body>
</html>
